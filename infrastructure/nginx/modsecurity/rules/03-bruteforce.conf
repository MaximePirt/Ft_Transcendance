#  003-bruteforce.conf
# Init IP collection for login attempts
SecAction \
    "id:100060,\
     phase:1,\
     nolog,\
     pass,\
     initcol:ip=%{REMOTE_ADDR}"

# Track login attempts and block after too many failures
SecRule REQUEST_METHOD "@streq POST" \
    "id:100061,\
     phase:2,\
     chain,\
     nolog,\
     pass,\
     setvar:ip.login_fail=+1,\
     expirevar:ip.login_fail=3600" \
SecRule REQUEST_METHOD "@streq POST" \
 "chain" \
SecRule RESPONSE_STATUS "@streq 401"

# Block IP after 5 failed login attempts
SecRule ip:login_fail "@ge 5" \
    "id:100062,\
     phase:2,\
     deny,\
     status:429,\
     log,\
     msg:'Too much login connection from same IP',\
     severity:'WARNING',\
     tag:'attack-bruteforce'"
