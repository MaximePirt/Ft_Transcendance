load_module modules/ngx_http_modsecurity_module.so;

user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
	worker_connections 1024;
}

http {
	ssl_protocols TLSv1.2 TLSv1.3;
	include       mime.types;
	server_tokens off;

	# Limit packet size
	client_body_buffer_size 128k;
	client_max_body_size 12m;
	# Add map to allow CORS from allowed URLs
	map $http_origin $allow_origin {
	default "";
	"~^https://localhost(:\d+)?$"   $http_origin;
	"~^https://dev\.local(:\d+)?$"  $http_origin;
	}

	# Redirect HTTP to HTTPS
	server {
		listen 80;
		listen [::]:80;
		server_name DOMAIN_NAME;
	
		location / {
			if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
				add_header Allow "GET, HEAD, OPTIONS" always;
				return 405;
			}
			return 301 https://$host$request_uri;
		}

	}

	# Main server block
	server {
		listen 443 ssl;
		listen [::]:443 ssl;
		server_name DOMAIN_NAME;

		ssl_certificate /etc/nginx/certs/fullchain.pem_DOMAIN_NAME.crt;
		ssl_certificate_key /etc/nginx/certs/privkey.pem_DOMAIN_NAME.key;
	
		# Enable ModSecurity
		modsecurity on;
		modsecurity_rules_file /etc/modsecurity/modsecurity.conf;
		# Additional nginx security headers (CORS)
		add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header X-Frame-Options "DENY" always;
		add_header X-Content-Type-Options "nosniff" always;
		add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;
		
		location @bruteforce429 {
			internal;
			default_type application/json;

			add_header Access-Control-Allow-Origin $allow_origin always;
			add_header Access-Control-Allow-Credentials "true" always;
			add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
			add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

			add_header Cache-Control "no-store" always;
			add_header Retry-After 900 always;
			add_header X-Brute-Force "1" always;
			return 429 '{"error":"too_many_attempts","message":"Too many failed login attempts. Please try again later."}';
		}

		# Needed to allow API requests to user
		location /api/ {
			proxy_intercept_errors on;
			error_page 429 = @bruteforce429;
			proxy_pass http://sqlite_api:3000/;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Proxy-Origin nginx;
		}

		location = /login {
		  if ($request_method = POST) {
			return 401;
		  }
		  return 200;
		}
		
		location / {
			if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
				add_header Allow "GET, HEAD, OPTIONS" always;
				return 405;
			}
			proxy_pass http://web:WEB_PORT;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}

	# API server block
	server {
		listen 443 ssl;
		listen [::]:443 ssl;
		server_name api.DOMAIN_NAME;

		ssl_certificate     /etc/nginx/certs/fullchain.pem_api.DOMAIN_NAME.crt;
		ssl_certificate_key /etc/nginx/certs/privkey.pem_api.DOMAIN_NAME.key;

		modsecurity on;
		modsecurity_rules_file /etc/modsecurity/modsecurity.conf;

		proxy_hide_header Access-Control-Allow-Origin;
		proxy_hide_header Access-Control-Allow-Credentials;
		proxy_hide_header Access-Control-Allow-Headers;
		proxy_hide_header Access-Control-Allow-Methods;

		add_header Vary "Origin" always;
		add_header Access-Control-Allow-Origin $allow_origin always;
		add_header Access-Control-Allow-Credentials "true" always;
		add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
		add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

		if ($request_method = OPTIONS) {
			return 204;
		}

		location / {
			proxy_pass http://sqlite_api:3000;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Proxy-Origin nginx;
		}
	}

	# WebSocket server block
	# server {
	# 	listen 443 ssl;
	# 	listen [::]:443 ssl;
	# 	server_name pong.ws.DOMAIN_NAME;

	# 	ssl_certificate /etc/nginx/certs/fullchain.pem_api.DOMAIN_NAME.crt;
	# 	ssl_certificate_key /etc/nginx/certs/privkey.pem_api.DOMAIN_NAME.key;

	# 	location / {
	# 		proxy_pass http://ws_server:3000;

	# 		proxy_http_version 1.1;
	# 		proxy_set_header Upgrade $http_upgrade;
	# 		proxy_set_header Connection "upgrade";

	# 		proxy_set_header Host $host;
	# 		proxy_set_header X-Real-IP $remote_addr;
	# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	# 		proxy_set_header X-Forwarded-Proto $scheme;
	# 	}
	# }
}
